<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Galaxy Requiem</title>
<style>
html,body{
  margin:0;
  padding:0;
  background:#000;
  overflow:hidden;
}
canvas{display:block;}
.hint{
  position:fixed;
  bottom:24px;
  left:50%;
  transform:translateX(-50%);
  color:rgba(255,255,255,.7);
  font:12px system-ui;
  letter-spacing:.2em;
}
</style>
</head>
<body>

<canvas id="c"></canvas>
<div class="hint">CLICK OR PRESS ANY KEY</div>

<script>
/* =====================================================
   GALAXY REQUIEM : CINEMATIC OPENING EXPERIENCE
   Canvas + WebAudio / No external dependencies
   ===================================================== */

const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");

function resize(){
  const dpr = Math.min(2, devicePixelRatio || 1);
  canvas.width = innerWidth * dpr;
  canvas.height = innerHeight * dpr;
  canvas.style.width = innerWidth + "px";
  canvas.style.height = innerHeight + "px";
  ctx.setTransform(1,0,0,1,0,0);
  ctx.scale(dpr,dpr);
}
addEventListener("resize", resize);
resize();

const CX = () => innerWidth / 2;
const CY = () => innerHeight / 2;

/* =======================
   AUDIO ENGINE (GUARANTEED)
   ======================= */
let audioCtx, master, osc1, osc2, lfo, lfoGain;
let audioStarted = false;

function startAudio(){
  if(audioStarted) return;
  audioStarted = true;

  audioCtx = new (window.AudioContext || window.webkitAudioContext)();

  master = audioCtx.createGain();
  master.gain.value = 0.0;
  master.connect(audioCtx.destination);

  osc1 = audioCtx.createOscillator(); // deep bass
  osc1.type = "sine";
  osc1.frequency.value = 32;

  osc2 = audioCtx.createOscillator(); // harmonic
  osc2.type = "triangle";
  osc2.frequency.value = 64;

  lfo = audioCtx.createOscillator();  // breathing
  lfo.type = "sine";
  lfo.frequency.value = 0.08;

  lfoGain = audioCtx.createGain();
  lfoGain.gain.value = 18;

  lfo.connect(lfoGain).connect(osc1.frequency);

  osc1.connect(master);
  osc2.connect(master);

  osc1.start();
  osc2.start();
  lfo.start();

  master.gain.linearRampToValueAtTime(
    0.18,
    audioCtx.currentTime + 4
  );

  document.querySelector(".hint")?.remove();
}

// 必ず音を出すためのユーザー操作フック
addEventListener("pointerdown", startAudio, { once:true });
addEventListener("keydown", startAudio, { once:true });

/* =======================
   GALAXY DATA
   ======================= */
const STARS = 6000;
const galaxy = [];

for(let i=0;i<STARS;i++){
  const r = Math.pow(Math.random(),0.35);
  galaxy.push({
    r,
    a: r*10 + Math.random()*0.8,
    s: 0.6 + Math.random()*1.6,
    h: 190 + Math.random()*60
  });
}

/* warp stars */
const WARP_N = 1400;
const warpStars = [];
function resetWarp(s){
  s.x = (Math.random()-0.5)*2;
  s.y = (Math.random()-0.5)*2;
  s.z = Math.random();
}
for(let i=0;i<WARP_N;i++){
  const s = {};
  resetWarp(s);
  warpStars.push(s);
}

/* =======================
   MAIN LOOP
   ======================= */
let t = 0;

function draw(){
  ctx.fillStyle = "rgba(0,0,0,0.25)";
  ctx.fillRect(0,0,innerWidth,innerHeight);

  const time = t % 36;

  const zoomIn  = Math.min(1, time/10);
  const warp    = Math.max(0, Math.min(1, (time-9)/6));
  const zoomOut = Math.max(0, Math.min(1, (time-22)/10));

  const zoom = 1 + zoomIn*5 - zoomOut*4;

  // audio sync
  if(audioStarted){
    osc1.frequency.setTargetAtTime(
      32 + warp*48,
      audioCtx.currentTime,
      0.2
    );
    osc2.frequency.setTargetAtTime(
      64 + warp*120,
      audioCtx.currentTime,
      0.2
    );
  }

  ctx.save();
  ctx.translate(CX(), CY());
  ctx.scale(zoom, zoom);

  // galaxy draw
  galaxy.forEach(s=>{
    const a = s.a + t*0.04;
    const r = s.r * Math.min(innerWidth,innerHeight)*0.48;
    let x = Math.cos(a)*r;
    let y = Math.sin(a)*r;

    const d = Math.sqrt(x*x + y*y) + 1;
    const lens = 1 + warp/(d*0.02);
    x *= lens; y *= lens;

    ctx.fillStyle = `hsla(${s.h},100%,70%,${1-warp})`;
    ctx.fillRect(x,y,s.s,s.s);
  });

  // core glow
  const core = ctx.createRadialGradient(0,0,0,0,0,140);
  core.addColorStop(0,"rgba(255,255,255,0.4)");
  core.addColorStop(0.4,"rgba(140,180,255,0.22)");
  core.addColorStop(1,"rgba(0,0,0,0)");
  ctx.fillStyle = core;
  ctx.beginPath();
  ctx.arc(0,0,140,0,Math.PI*2);
  ctx.fill();

  ctx.restore();

  // warp stars
  if(warp > 0){
    warpStars.forEach(s=>{
      s.z -= 0.02 * warp;
      if(s.z < 0.02) resetWarp(s);

      const x = CX() + s.x/s.z * CX();
      const y = CY() + s.y/s.z * CY();
      const len = (1-s.z)*25*warp;

      ctx.strokeStyle = "rgba(255,255,255,0.85)";
      ctx.beginPath();
      ctx.moveTo(x,y);
      ctx.lineTo(x - s.x*len, y - s.y*len);
      ctx.stroke();
    });
  }

  // title
  if(time > 3 && time < 9){
    ctx.save();
    ctx.fillStyle = "rgba(255,255,255,0.6)";
    ctx.font = "48px serif";
    ctx.textAlign = "center";
    ctx.fillText("GALAXY REQUIEM", CX(), CY() + innerHeight*0.28);
    ctx.restore();
  }

  t += 0.016;
  requestAnimationFrame(draw);
}

draw();
</script>
</body>
</html>
